<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Greenhouse Layout Designer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
        }
        
        .main-content {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .sidebar {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            padding: 2rem;
            height: fit-content;
        }
        
        .wizard-steps {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .wizard-step {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .wizard-step.active {
            background: white;
            color: #27ae60;
            font-weight: bold;
        }
        
        .wizard-step.completed {
            color: #27ae60;
            background: #e8f5e9;
        }
        
        .step-content {
            padding: 2rem;
            display: none;
        }
        
        .step-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #27ae60;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        
        .greenhouse-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .greenhouse-card {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .greenhouse-card:hover,
        .greenhouse-card.selected {
            border-color: #27ae60;
            background: #e8f5e9;
            transform: translateY(-2px);
        }
        
        .greenhouse-card h4 {
            color: #27ae60;
            margin-bottom: 0.5rem;
        }
        
        /* Interactive Layout Styles */
        .layout-container {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        
        .greenhouse-outline {
            border: 3px solid #34495e;
            border-radius: 8px;
            position: relative;
            margin: 2rem auto;
            background: #ecf0f1;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }
        
        .bed-grid {
            position: absolute;
            top: 24px; /* 2 feet perimeter space scaled */
            left: 24px;
            right: 24px;
            bottom: 24px;
            display: grid;
            gap: 18px; /* 3 feet walkway scaled */
        }
        
        .grow-bed {
            background: #bdc3c7;
            border: 2px solid #95a5a6;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
            padding: 0.5rem;
        }
        
        .grow-bed:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .grow-bed.configured {
            border-color: #27ae60;
            color: white;
        }
        
        .grow-bed.traditional {
            background: #8B4513;
        }
        
        .grow-bed.hydroponics {
            background: #3498db;
        }
        
        .grow-bed.aquaponics {
            background: #16a085;
        }
        
        .grow-bed.empty {
            background: #bdc3c7;
        }
        
        .bed-label {
            font-size: 0.7rem;
            line-height: 1;
        }
        
        .crop-name {
            font-size: 0.6rem;
            margin-top: 2px;
            opacity: 0.9;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e9ecef;
        }
        
        .close {
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            color: #95a5a6;
            line-height: 1;
        }
        
        .close:hover {
            color: #e74c3c;
        }
        
        .growing-system-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .system-card {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .system-card:hover,
        .system-card.selected {
            border-color: #27ae60;
            background: #e8f5e9;
        }
        
        .system-card h4 {
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }
        
        .system-card.selected h4 {
            color: #27ae60;
        }
        
        .bed-type-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .bed-type-card {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .bed-type-card:hover,
        .bed-type-card.selected {
            border-color: #27ae60;
            background: #e8f5e9;
        }
        
        .sidebar h3 {
            color: #27ae60;
            margin-bottom: 1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #27ae60;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.25rem;
        }
        
        .legend {
            margin-bottom: 2rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 0.5rem;
        }
        
        .configured-beds {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .bed-summary {
            background: #f8f9fa;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 5px;
            border-left: 4px solid #27ae60;
        }
        
        .bed-summary h5 {
            margin-bottom: 0.25rem;
            color: #2c3e50;
        }
        
        .bed-summary small {
            color: #666;
        }
        
        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #27ae60;
            color: white;
        }
        
        .btn-primary:hover {
            background: #229954;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e9ecef;
        }
        
        .crop-suggestions {
            background: #e8f5e9;
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
        }
        
        .suggestion-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .suggestion-chip {
            background: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            border: 1px solid #27ae60;
            color: #27ae60;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .suggestion-chip:hover {
            background: #27ae60;
            color: white;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #27ae60;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå± Interactive Greenhouse Layout Designer</h1>
        <p>Click on grow beds to customize crops and growing systems</p>
    </div>
    
    <div class="container">
        <div class="main-content">
            <div class="wizard-steps">
                <div class="wizard-step active" data-step="1">1. Greenhouse</div>
                <div class="wizard-step" data-step="2">2. Dimensions</div>
                <div class="wizard-step" data-step="3">3. Layout Design</div>
                <div class="wizard-step" data-step="4">4. Materials</div>
            </div>
            
            <div class="step-content active" id="step1">
                <h2>Select Greenhouse Type</h2>
                <div class="greenhouse-types" id="greenhouseTypes">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
            
            <div class="step-content" id="step2">
                <h2>Greenhouse Dimensions & Location</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Length (feet)</label>
                        <input type="number" id="length" min="16" max="200" value="32" required>
                        <small>Minimum 16 feet for 4x8 beds</small>
                    </div>
                    <div class="form-group">
                        <label>Width (feet)</label>
                        <input type="number" id="width" min="12" max="50" value="20" required>
                        <small>Minimum 12 feet for beds + walkways</small>
                    </div>
                    <div class="form-group">
                        <label>Height (feet)</label>
                        <input type="number" id="height" min="8" max="20" value="12" required>
                    </div>
                </div>
                
                <h3 style="margin-top: 2rem;">Location</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Climate Zone</label>
                        <select id="climateZone" required>
                            <option value="3a">3a (-40 to -35¬∞F)</option>
                            <option value="4a">4a (-30 to -25¬∞F)</option>
                            <option value="5a">5a (-20 to -15¬∞F)</option>
                            <option value="6a">6a (-10 to -5¬∞F)</option>
                            <option value="6b" selected>6b (-5 to 0¬∞F)</option>
                            <option value="7a">7a (0 to 5¬∞F)</option>
                            <option value="8a">8a (10 to 15¬∞F)</option>
                            <option value="9a">9a (20 to 25¬∞F)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="step-content" id="step3">
                <h2>Design Your Layout</h2>
                <p style="margin-bottom: 1rem; color: #666;">Click on any grow bed to configure crops and growing system</p>
                
                <div class="layout-container">
                    <div class="greenhouse-outline" id="greenhouseOutline">
                        <div class="bed-grid" id="bedGrid">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="step-content" id="step4">
                <h2>Materials List</h2>
                <div id="materialsList">
                    <!-- Populated by JavaScript -->
                </div>
                
                <div style="text-align: center; margin-top: 2rem;">
                    <button class="btn-primary" onclick="exportPlan()">Export Complete Plan</button>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn-secondary" onclick="previousStep()" id="prevBtn" style="display: none;">Previous</button>
                <button class="btn-primary" onclick="nextStep()" id="nextBtn">Next</button>
            </div>
        </div>
        
        <div class="sidebar">
            <h3>Layout Statistics</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalBeds">0</div>
                    <div class="stat-label">Total Beds</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="configuredBeds">0</div>
                    <div class="stat-label">Configured</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="growingArea">0 ft¬≤</div>
                    <div class="stat-label">Growing Area</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="spaceEfficiency">0%</div>
                    <div class="stat-label">Efficiency</div>
                </div>
            </div>
            
            <div class="legend">
                <h3>Growing Systems</h3>
                <div class="legend-item">
                    <div class="legend-color" style="background: #8B4513;"></div>
                    <span>Traditional Soil</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #3498db;"></div>
                    <span>Hydroponics</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #16a085;"></div>
                    <span>Aquaponics</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #bdc3c7;"></div>
                    <span>Unconfigured</span>
                </div>
            </div>
            
            <div class="configured-beds">
                <h3>Configured Beds</h3>
                <div id="bedSummaries">
                    <p style="color: #666; font-style: italic;">No beds configured yet. Click on beds to add crops.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bed Configuration Modal -->
    <div id="bedModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Configure Grow Bed</h2>
                <span class="close" onclick="closeBedModal()">&times;</span>
            </div>
            
            <div class="form-group">
                <label>Growing System</label>
                <div class="growing-system-selector">
                    <div class="system-card" onclick="selectGrowingSystem('traditional')">
                        <h4>üå± Traditional</h4>
                        <p>Soil-based growing</p>
                    </div>
                    <div class="system-card" onclick="selectGrowingSystem('hydroponics')">
                        <h4>üíß Hydroponics</h4>
                        <p>Soilless, nutrient solution</p>
                    </div>
                    <div class="system-card" onclick="selectGrowingSystem('aquaponics')">
                        <h4>üêü Aquaponics</h4>
                        <p>Fish + plants system</p>
                    </div>
                </div>
            </div>
            
            <div class="form-group" id="bedTypeSection" style="display: none;">
                <label>Bed Type</label>
                <div class="bed-type-selector" id="bedTypeSelector">
                    <!-- Populated based on growing system -->
                </div>
            </div>
            
            <div class="form-group">
                <label>Primary Crop</label>
                <input type="text" id="primaryCrop" placeholder="e.g., Tomatoes, Lettuce, Basil" list="cropList">
                <datalist id="cropList">
                    <option value="Tomatoes">
                    <option value="Lettuce">
                    <option value="Peppers">
                    <option value="Cucumbers">
                    <option value="Basil">
                    <option value="Spinach">
                    <option value="Kale">
                    <option value="Strawberries">
                    <option value="Beans">
                    <option value="Carrots">
                    <option value="Radishes">
                    <option value="Chard">
                    <option value="Cilantro">
                    <option value="Parsley">
                    <option value="Oregano">
                    <option value="Thyme">
                </datalist>
            </div>
            
            <div class="crop-suggestions" id="cropSuggestions" style="display: none;">
                <h4>üí° Companion Plant Suggestions</h4>
                <div class="suggestion-chips" id="suggestionChips">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
            
            <div class="form-group">
                <label>Companion Crops (optional)</label>
                <input type="text" id="companionCrops" placeholder="e.g., Basil, Marigolds">
                <small>Separate multiple crops with commas</small>
            </div>
            
            <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn-danger" onclick="clearBed()" id="clearBedBtn" style="display: none;">Clear Bed</button>
                <button class="btn-secondary" onclick="closeBedModal()">Cancel</button>
                <button class="btn-primary" onclick="saveBedConfiguration()">Save Configuration</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentStep = 1;
        let greenhousePlan = {
            type: null,
            dimensions: {},
            beds: {},
            layout: {}
        };
        let currentBedId = null;
        let selectedGrowingSystem = null;
        let selectedBedType = null;
        
        // Plant validation data
        const rootVegetables = ['carrots', 'carrot', 'radishes', 'radish', 'beets', 'beet', 'turnips', 'turnip', 'potatoes', 'potato', 'sweet potatoes', 'sweet potato', 'parsnips', 'parsnip', 'onions', 'onion', 'garlic', 'ginger', 'turmeric'];
        const trees = ['apple', 'pear', 'peach', 'cherry', 'citrus', 'lemon', 'orange', 'lime', 'avocado', 'fig', 'blueberry', 'raspberry', 'blackberry', 'grape', 'strawberry'];
        const soilOnlyBedTypes = ['standing_soil'];
        const hydroponicBedTypes = ['nft', 'dwc', 'media_bed', 'fill_and_drain'];
        
        // Validation function for bed types
        function validateBedTypeForCrop(cropName, bedType) {
            const normalizedCrop = cropName.toLowerCase().trim();
            
            // Check if it's a root vegetable
            const isRootVegetable = rootVegetables.some(rootVeg => normalizedCrop.includes(rootVeg));
            
            // Check if it's a tree or perennial
            const isTree = trees.some(tree => normalizedCrop.includes(tree));
            
            // Root vegetables and trees need soil beds
            if ((isRootVegetable || isTree) && hydroponicBedTypes.includes(bedType)) {
                if (isRootVegetable) {
                    return {
                        isValid: false,
                        message: `${cropName} is a root vegetable and cannot be grown in hydroponic systems like ${bedType}. Root vegetables need soil beds for proper development.`
                    };
                } else {
                    return {
                        isValid: false,
                        message: `${cropName} is a tree/perennial and requires soil beds for its extensive root system. Hydroponic systems like ${bedType} are not suitable.`
                    };
                }
            }
            
            return { isValid: true };
        }
        
        // Greenhouse types
        const greenhouseTypes = [
            {
                type: 'hoop_house',
                name: 'Hoop House',
                description: 'Simple arched structure',
                advantages: ['Low cost', 'Easy setup']
            },
            {
                type: 'traditional_gable',
                name: 'Traditional Gable',
                description: 'Classic peaked roof',
                advantages: ['Maximum headroom', 'Professional look']
            },
            {
                type: 'quonset',
                name: 'Quonset Hut',
                description: 'Semi-circular arch',
                advantages: ['Strong structure', 'Commercial grade']
            },
            {
                type: 'geodesic_dome',
                name: 'Geodesic Dome',
                description: 'Spherical design',
                advantages: ['Wind resistant', 'Energy efficient']
            }
        ];
        
        // Bed types for each growing system
        const bedTypes = {
            traditional: [
                { type: 'raised_soil', name: 'Raised Soil Bed', description: 'Traditional raised bed with soil mix' },
                { type: 'container', name: 'Container Garden', description: 'Individual containers or pots' }
            ],
            hydroponics: [
                { type: 'fill_and_drain', name: 'Fill & Drain', description: 'Ebb and flow system' },
                { type: 'nft', name: 'NFT System', description: 'Nutrient film technique' },
                { type: 'dwc', name: 'Deep Water Culture', description: 'Roots in oxygenated solution' },
                { type: 'media_bed', name: 'Media Bed', description: 'Continuous flow through medium' }
            ],
            aquaponics: [
                { type: 'media_bed_aqua', name: 'Media Bed', description: 'Gravel bed with fish waste nutrients' },
                { type: 'raft_system', name: 'Raft System', description: 'Floating rafts in fish water' },
                { type: 'nft_aqua', name: 'NFT Aquaponics', description: 'NFT system with fish nutrients' }
            ]
        };
        
        // Companion planting suggestions
        const companionSuggestions = {
            'Tomatoes': ['Basil', 'Marigolds', 'Carrots', 'Nasturtiums'],
            'Lettuce': ['Radishes', 'Carrots', 'Chives', 'Strawberries'],
            'Peppers': ['Basil', 'Onions', 'Spinach', 'Tomatoes'],
            'Cucumbers': ['Beans', 'Radishes', 'Peas', 'Nasturtiums'],
            'Basil': ['Tomatoes', 'Peppers', 'Lettuce', 'Oregano'],
            'Spinach': ['Strawberries', 'Radishes', 'Lettuce', 'Peas'],
            'Kale': ['Onions', 'Garlic', 'Carrots', 'Beets'],
            'Strawberries': ['Lettuce', 'Spinach', 'Thyme', 'Chives']
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            populateGreenhouseTypes();
            
            // Add event listeners
            document.getElementById('primaryCrop').addEventListener('input', function() {
                showCompanionSuggestions(this.value);
            });
        });
        
        function populateGreenhouseTypes() {
            const container = document.getElementById('greenhouseTypes');
            container.innerHTML = greenhouseTypes.map(type => `
                <div class="greenhouse-card" onclick="selectGreenhouseType('${type.type}')">
                    <h4>${type.name}</h4>
                    <p>${type.description}</p>
                    <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                        ${type.advantages.map(adv => `<li>${adv}</li>`).join('')}
                    </ul>
                </div>
            `).join('');
        }
        
        function selectGreenhouseType(type) {
            greenhousePlan.type = type;
            document.querySelectorAll('.greenhouse-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.greenhouse-card').classList.add('selected');
        }
        
        function calculateLayout() {
            const length = parseInt(document.getElementById('length').value);
            const width = parseInt(document.getElementById('width').value);
            
            // Constants for bed layout
            const bedLength = 8; // feet
            const bedWidth = 4; // feet
            const walkwayWidth = 3; // feet
            const perimeterSpace = 2; // feet
            
            // Calculate available space
            const availableLength = length - (2 * perimeterSpace);
            const availableWidth = width - (2 * perimeterSpace);
            
            // Calculate maximum beds that can fit
            const maxBedsLengthwise = Math.floor((availableLength + walkwayWidth) / (bedLength + walkwayWidth));
            const maxBedsWidthwise = Math.floor((availableWidth + walkwayWidth) / (bedWidth + walkwayWidth));
            
            const totalBeds = maxBedsLengthwise * maxBedsWidthwise;
            
            greenhousePlan.layout = {
                totalBeds,
                bedsPerRow: maxBedsLengthwise,
                rows: maxBedsWidthwise,
                bedLength,
                bedWidth,
                walkwayWidth,
                dimensions: { length, width }
            };
            
            createBedLayout();
            updateStats();
        }
        
        function createBedLayout() {
            const { totalBeds, bedsPerRow, rows, dimensions } = greenhousePlan.layout;
            
            // Set greenhouse outline dimensions (scaled for display)
            const scale = 12; // 1 foot = 12px
            const outline = document.getElementById('greenhouseOutline');
            outline.style.width = (dimensions.length * scale) + 'px';
            outline.style.height = (dimensions.width * scale) + 'px';
            
            const bedGrid = document.getElementById('bedGrid');
            bedGrid.style.gridTemplateColumns = `repeat(${bedsPerRow}, 1fr)`;
            bedGrid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
            
            // Create bed elements
            let bedHTML = '';
            for (let i = 0; i < totalBeds; i++) {
                const bedId = `bed-${i + 1}`;
                const bedConfig = greenhousePlan.beds[bedId];
                
                let bedClass = 'grow-bed empty';
                let bedContent = `<div class="bed-label">Bed ${i + 1}</div>`;
                
                if (bedConfig) {
                    bedClass = `grow-bed configured ${bedConfig.growingSystem}`;
                    bedContent = `
                        <div class="bed-label">Bed ${i + 1}</div>
                        <div class="crop-name">${bedConfig.primaryCrop}</div>
                    `;
                }
                
                bedHTML += `<div class="${bedClass}" id="${bedId}" onclick="openBedModal('${bedId}')">${bedContent}</div>`;
            }
            
            bedGrid.innerHTML = bedHTML;
        }
        
        function openBedModal(bedId) {
            currentBedId = bedId;
            const bedConfig = greenhousePlan.beds[bedId];
            
            // Reset modal
            document.getElementById('modalTitle').textContent = `Configure ${bedId.replace('-', ' ').toUpperCase()}`;
            
            // Clear form
            clearModalForm();
            
            // If bed is already configured, populate form
            if (bedConfig) {
                selectedGrowingSystem = bedConfig.growingSystem;
                selectedBedType = bedConfig.bedType;
                document.getElementById('primaryCrop').value = bedConfig.primaryCrop || '';
                document.getElementById('companionCrops').value = bedConfig.companionCrops?.join(', ') || '';
                
                // Highlight selected growing system
                updateGrowingSystemSelection();
                showBedTypes();
                updateBedTypeSelection();
                
                document.getElementById('clearBedBtn').style.display = 'block';
            } else {
                document.getElementById('clearBedBtn').style.display = 'none';
            }
            
            document.getElementById('bedModal').style.display = 'block';
        }
        
        function closeBedModal() {
            document.getElementById('bedModal').style.display = 'none';
            currentBedId = null;
            selectedGrowingSystem = null;
            selectedBedType = null;
        }
        
        function clearModalForm() {
            document.getElementById('primaryCrop').value = '';
            document.getElementById('companionCrops').value = '';
            document.getElementById('cropSuggestions').style.display = 'none';
            document.getElementById('bedTypeSection').style.display = 'none';
            
            // Clear selections
            document.querySelectorAll('.system-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelectorAll('.bed-type-card').forEach(card => {
                card.classList.remove('selected');
            });
        }
        
        function selectGrowingSystem(system) {
            selectedGrowingSystem = system;
            updateGrowingSystemSelection();
            showBedTypes();
        }
        
        function updateGrowingSystemSelection() {
            document.querySelectorAll('.system-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            const systemCards = document.querySelectorAll('.system-card');
            const systemIndex = ['traditional', 'hydroponics', 'aquaponics'].indexOf(selectedGrowingSystem);
            if (systemIndex >= 0 && systemCards[systemIndex]) {
                systemCards[systemIndex].classList.add('selected');
            }
        }
        
        function showBedTypes() {
            if (!selectedGrowingSystem) return;
            
            const bedTypeSection = document.getElementById('bedTypeSection');
            const bedTypeSelector = document.getElementById('bedTypeSelector');
            
            const types = bedTypes[selectedGrowingSystem];
            bedTypeSelector.innerHTML = types.map(type => `
                <div class="bed-type-card" onclick="selectBedType('${type.type}')">
                    <h5>${type.name}</h5>
                    <p>${type.description}</p>
                </div>
            `).join('');
            
            bedTypeSection.style.display = 'block';
        }
        
        function selectBedType(type) {
            selectedBedType = type;
            updateBedTypeSelection();
        }
        
        function updateBedTypeSelection() {
            document.querySelectorAll('.bed-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            const cards = document.querySelectorAll('.bed-type-card');
            cards.forEach(card => {
                if (card.onclick.toString().includes(selectedBedType)) {
                    card.classList.add('selected');
                }
            });
        }
        
        function showCompanionSuggestions(crop) {
            if (!crop || crop.length < 2) {
                document.getElementById('cropSuggestions').style.display = 'none';
                return;
            }
            
            const suggestions = companionSuggestions[crop] || [];
            if (suggestions.length === 0) return;
            
            const suggestionsDiv = document.getElementById('cropSuggestions');
            const chipsContainer = document.getElementById('suggestionChips');
            
            chipsContainer.innerHTML = suggestions.map(suggestion => 
                `<span class="suggestion-chip" onclick="addCompanionCrop('${suggestion}')">${suggestion}</span>`
            ).join('');
            
            suggestionsDiv.style.display = 'block';
        }
        
        function addCompanionCrop(crop) {
            const companionInput = document.getElementById('companionCrops');
            const currentValue = companionInput.value;
            const crops = currentValue ? currentValue.split(',').map(c => c.trim()) : [];
            
            if (!crops.includes(crop)) {
                crops.push(crop);
                companionInput.value = crops.join(', ');
            }
        }
        
        function saveBedConfiguration() {
            if (!currentBedId || !selectedGrowingSystem || !selectedBedType) {
                alert('Please select a growing system and bed type');
                return;
            }
            
            const primaryCrop = document.getElementById('primaryCrop').value.trim();
            if (!primaryCrop) {
                alert('Please enter a primary crop');
                return;
            }
            
            // Validate bed type for rooted plants
            const validationResult = validateBedTypeForCrop(primaryCrop, selectedBedType);
            if (!validationResult.isValid) {
                alert(validationResult.message);
                return;
            }
            
            const companionCropsValue = document.getElementById('companionCrops').value.trim();
            const companionCrops = companionCropsValue ? 
                companionCropsValue.split(',').map(c => c.trim()).filter(c => c) : [];
            
            // Save bed configuration
            greenhousePlan.beds[currentBedId] = {
                growingSystem: selectedGrowingSystem,
                bedType: selectedBedType,
                primaryCrop,
                companionCrops
            };
            
            // Update the bed visual
            updateBedVisual(currentBedId);
            updateStats();
            updateBedSummaries();
            
            closeBedModal();
        }
        
        function clearBed() {
            if (currentBedId && greenhousePlan.beds[currentBedId]) {
                delete greenhousePlan.beds[currentBedId];
                updateBedVisual(currentBedId);
                updateStats();
                updateBedSummaries();
                closeBedModal();
            }
        }
        
        function updateBedVisual(bedId) {
            const bedElement = document.getElementById(bedId);
            const bedConfig = greenhousePlan.beds[bedId];
            
            if (bedConfig) {
                bedElement.className = `grow-bed configured ${bedConfig.growingSystem}`;
                bedElement.innerHTML = `
                    <div class="bed-label">${bedId.replace('-', ' ').toUpperCase()}</div>
                    <div class="crop-name">${bedConfig.primaryCrop}</div>
                `;
            } else {
                bedElement.className = 'grow-bed empty';
                bedElement.innerHTML = `<div class="bed-label">${bedId.replace('-', ' ').toUpperCase()}</div>`;
            }
        }
        
        function updateStats() {
            const totalBeds = greenhousePlan.layout.totalBeds || 0;
            const configuredBedsCount = Object.keys(greenhousePlan.beds).length;
            const growingArea = configuredBedsCount * 32; // 4x8 = 32 sq ft
            const totalArea = greenhousePlan.layout.dimensions ? 
                greenhousePlan.layout.dimensions.length * greenhousePlan.layout.dimensions.width : 0;
            const efficiency = totalArea > 0 ? Math.round((growingArea / totalArea) * 100) : 0;
            
            document.getElementById('totalBeds').textContent = totalBeds;
            document.getElementById('configuredBeds').textContent = configuredBedsCount;
            document.getElementById('growingArea').textContent = growingArea + ' ft¬≤';
            document.getElementById('spaceEfficiency').textContent = efficiency + '%';
        }
        
        function updateBedSummaries() {
            const container = document.getElementById('bedSummaries');
            const configuredBeds = Object.entries(greenhousePlan.beds);
            
            if (configuredBeds.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No beds configured yet. Click on beds to add crops.</p>';
                return;
            }
            
            container.innerHTML = configuredBeds.map(([bedId, config]) => `
                <div class="bed-summary">
                    <h5>${bedId.replace('-', ' ').toUpperCase()}</h5>
                    <small>
                        ${config.primaryCrop} ‚Ä¢ ${config.growingSystem.replace('_', ' ')} ‚Ä¢ ${config.bedType.replace('_', ' ')}
                        ${config.companionCrops?.length ? '<br>+ ' + config.companionCrops.join(', ') : ''}
                    </small>
                </div>
            `).join('');
        }
        
        function nextStep() {
            if (validateCurrentStep()) {
                document.querySelector(`[data-step="${currentStep}"]`).classList.add('completed');
                document.getElementById(`step${currentStep}`).classList.remove('active');
                currentStep++;
                document.getElementById(`step${currentStep}`).classList.add('active');
                document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');
                
                updateButtons();
                
                if (currentStep === 3) {
                    calculateLayout();
                } else if (currentStep === 4) {
                    generateMaterialsList();
                }
            }
        }
        
        function previousStep() {
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.querySelector(`[data-step="${currentStep}"]`).classList.remove('active');
            currentStep--;
            document.getElementById(`step${currentStep}`).classList.add('active');
            document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');
            updateButtons();
        }
        
        function updateButtons() {
            document.getElementById('prevBtn').style.display = currentStep > 1 ? 'block' : 'none';
            document.getElementById('nextBtn').style.display = currentStep < 4 ? 'block' : 'none';
        }
        
        function validateCurrentStep() {
            switch (currentStep) {
                case 1:
                    if (!greenhousePlan.type) {
                        alert('Please select a greenhouse type');
                        return false;
                    }
                    break;
                case 2:
                    const length = document.getElementById('length').value;
                    const width = document.getElementById('width').value;
                    if (!length || !width) {
                        alert('Please enter greenhouse dimensions');
                        return false;
                    }
                    greenhousePlan.dimensions = {
                        length: parseInt(length),
                        width: parseInt(width),
                        height: parseInt(document.getElementById('height').value),
                        climate_zone: document.getElementById('climateZone').value
                    };
                    break;
                case 3:
                    // Optional validation - user can proceed with empty beds
                    break;
            }
            return true;
        }
        
        function generateMaterialsList() {
            const materialsList = document.getElementById('materialsList');
            materialsList.innerHTML = '<p>Generating materials list... <span class="loading"></span></p>';
            
            setTimeout(() => {
                displayMaterialsList();
            }, 1000);
        }
        
        function displayMaterialsList() {
            const materialsList = document.getElementById('materialsList');
            const { length, width } = greenhousePlan.dimensions;
            const area = length * width;
            const configuredBeds = Object.values(greenhousePlan.beds);
            
            // Group beds by system and type
            const bedGroups = {};
            configuredBeds.forEach(bed => {
                const key = `${bed.growingSystem}_${bed.bedType}`;
                if (!bedGroups[key]) {
                    bedGroups[key] = { ...bed, count: 0 };
                }
                bedGroups[key].count++;
            });
            
            let html = `
                <div style="background: #f8f9fa; padding: 2rem; border-radius: 8px;">
                    <h3>Complete Materials List</h3>
                    
                    <div style="margin-bottom: 2rem;">
                        <h4>üèóÔ∏è Greenhouse Structure</h4>
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 1rem; margin: 1rem 0; font-weight: bold; background: #e9ecef; padding: 0.5rem; border-radius: 5px;">
                            <div>Item</div>
                            <div>Quantity</div>
                            <div>Unit Cost</div>
                            <div>Total</div>
                        </div>
            `;
            
            let totalCost = 0;
            
            // Greenhouse structure materials
            const structureMaterials = [
                { name: `${greenhousePlan.type.replace('_', ' ')} Frame Kit`, qty: 1, unit: 'kit', cost: 2500 },
                { name: 'Covering Material', qty: Math.ceil(area * 1.3), unit: 'sq ft', cost: Math.ceil(area * 1.3 * 0.15) },
                { name: 'Foundation Materials', qty: Math.ceil((length + width) * 2), unit: 'linear ft', cost: Math.ceil((length + width) * 2 * 12) }
            ];
            
            structureMaterials.forEach(item => {
                totalCost += item.cost;
                html += `
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 1rem; padding: 0.5rem; border-bottom: 1px solid #e9ecef;">
                        <div>${item.name}</div>
                        <div>${item.qty}</div>
                        <div>$${(item.cost / item.qty).toFixed(2)}</div>
                        <div>$${item.cost}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Grow bed materials by type
            if (Object.keys(bedGroups).length > 0) {
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h4>üå± Grow Bed Systems</h4>
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 1rem; margin: 1rem 0; font-weight: bold; background: #e9ecef; padding: 0.5rem; border-radius: 5px;">
                            <div>System Type</div>
                            <div>Quantity</div>
                            <div>Unit Cost</div>
                            <div>Total</div>
                        </div>
                `;
                
                Object.entries(bedGroups).forEach(([key, bedGroup]) => {
                    const systemName = `${bedGroup.growingSystem} - ${bedGroup.bedType}`.replace(/_/g, ' ');
                    const unitCost = getBedSystemCost(bedGroup.growingSystem, bedGroup.bedType);
                    const totalBedCost = unitCost * bedGroup.count;
                    totalCost += totalBedCost;
                    
                    html += `
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 1rem; padding: 0.5rem; border-bottom: 1px solid #e9ecef;">
                            <div>${systemName}</div>
                            <div>${bedGroup.count} beds</div>
                            <div>$${unitCost}/bed</div>
                            <div>$${totalBedCost}</div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            // Additional systems
            html += `
                <div style="margin-bottom: 2rem;">
                    <h4>‚ö° Additional Systems</h4>
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 1rem; margin: 1rem 0; font-weight: bold; background: #e9ecef; padding: 0.5rem; border-radius: 5px;">
                        <div>Item</div>
                        <div>Quantity</div>
                        <div>Unit Cost</div>
                        <div>Total</div>
                    </div>
            `;
            
            const additionalSystems = [
                { name: 'Ventilation System', qty: Math.ceil(length / 20), cost: 300 },
                { name: 'Electrical Setup', qty: 1, cost: 800 },
                { name: 'Water Supply System', qty: 1, cost: 500 }
            ];
            
            additionalSystems.forEach(item => {
                const totalItemCost = item.cost * item.qty;
                totalCost += totalItemCost;
                html += `
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 1rem; padding: 0.5rem; border-bottom: 1px solid #e9ecef;">
                        <div>${item.name}</div>
                        <div>${item.qty}</div>
                        <div>$${item.cost}</div>
                        <div>$${totalItemCost}</div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    
                    <div style="background: #27ae60; color: white; padding: 1.5rem; border-radius: 8px; text-align: center; margin-top: 2rem;">
                        <h3>Total Estimated Cost: $${totalCost.toLocaleString()}</h3>
                        <p style="margin-top: 0.5rem; opacity: 0.9;">
                            ${length}' √ó ${width}' ${greenhousePlan.type.replace('_', ' ')} with ${Object.keys(greenhousePlan.beds).length} configured beds
                        </p>
                    </div>
                </div>
            `;
            
            materialsList.innerHTML = html;
        }
        
        function getBedSystemCost(growingSystem, bedType) {
            const costs = {
                traditional: { raised_soil: 120, container: 80 },
                hydroponics: { fill_and_drain: 180, nft: 150, dwc: 160, media_bed: 170 },
                aquaponics: { media_bed_aqua: 220, raft_system: 200, nft_aqua: 180 }
            };
            return costs[growingSystem]?.[bedType] || 150;
        }
        
        function exportPlan() {
            const configuredBeds = Object.entries(greenhousePlan.beds);
            
            let csv = 'Interactive Greenhouse Layout Plan\n\n';
            csv += 'GREENHOUSE CONFIGURATION\n';
            csv += `Type,${greenhousePlan.type.replace('_', ' ')}\n`;
            csv += `Dimensions,${greenhousePlan.dimensions.length} x ${greenhousePlan.dimensions.width} x ${greenhousePlan.dimensions.height} feet\n`;
            csv += `Climate Zone,${greenhousePlan.dimensions.climate_zone}\n`;
            csv += `Total Beds Available,${greenhousePlan.layout.totalBeds}\n`;
            csv += `Beds Configured,${configuredBeds.length}\n\n`;
            
            csv += 'BED CONFIGURATIONS\n';
            csv += 'Bed ID,Growing System,Bed Type,Primary Crop,Companion Crops\n';
            
            configuredBeds.forEach(([bedId, config]) => {
                csv += `${bedId},${config.growingSystem},${config.bedType},${config.primaryCrop},"${config.companionCrops?.join(', ') || 'None'}"\n`;
            });
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'greenhouse-layout-plan.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('bedModal');
            if (event.target === modal) {
                closeBedModal();
            }
        }
    </script>
</body>
</html>